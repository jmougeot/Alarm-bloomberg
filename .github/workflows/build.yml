name: Build Desktop App

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:  # Permet de lancer manuellement depuis GitHub

# Permissions n√©cessaires pour cr√©er des releases
permissions:
  contents: write

env:
  APP_NAME: "Strategy Monitor"
  PYTHON_VERSION: "3.11"

jobs:
  # ===========================================
  # BUILD WINDOWS
  # ===========================================
  build-windows:
    name: ü™ü Build Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Windows executable
        run: |
          python -m PyInstaller --clean --noconfirm --workpath build/temp --distpath dist build/strategy_monitor.spec

      - name: List build output
        run: |
          dir dist
        shell: cmd

      - name: Upload Windows build
        uses: actions/upload-artifact@v4
        with:
          name: Strategy-Monitor-Windows
          path: dist/**/*.exe
          if-no-files-found: error

  # ===========================================
  # BUILD MACOS
  # ===========================================
  build-macos:
    name: üçé Build macOS
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt
          pip3 install pyinstaller

      - name: Build macOS app
        run: |
          python3 -m PyInstaller --clean --noconfirm --workpath build/temp --distpath dist build/strategy_monitor.spec

      - name: List build output
        run: ls -laR dist/

      - name: Create DMG
        run: |
          # Install create-dmg
          brew install create-dmg
          
          # Create DMG (handle app bundle path)
          if [ -d "dist/${{ env.APP_NAME }}.app" ]; then
            APP_PATH="dist/${{ env.APP_NAME }}.app"
          elif [ -d "dist/${{ env.APP_NAME }}/${{ env.APP_NAME }}.app" ]; then
            APP_PATH="dist/${{ env.APP_NAME }}/${{ env.APP_NAME }}.app"
          else
            echo "App not found, listing dist:"
            ls -laR dist/
            exit 1
          fi
          
          create-dmg \
            --volname "${{ env.APP_NAME }}" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "${{ env.APP_NAME }}.app" 150 200 \
            --hide-extension "${{ env.APP_NAME }}.app" \
            --app-drop-link 450 200 \
            --no-internet-enable \
            "dist/${{ env.APP_NAME }}.dmg" \
            "$APP_PATH" || true

      - name: Upload macOS App
        uses: actions/upload-artifact@v4
        with:
          name: Strategy-Monitor-macOS-App
          path: dist/**/*.app
          if-no-files-found: error

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: Strategy-Monitor-macOS-DMG
          path: dist/*.dmg
          if-no-files-found: warn

  # ===========================================
  # CREATE RELEASE (only on tags)
  # ===========================================
  release:
    name: üì¶ Create Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.APP_NAME }} ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
          body: |
            ## üöÄ ${{ env.APP_NAME }} ${{ github.ref_name }}
            
            ### Downloads
            - **Windows**: `Strategy Monitor.exe`
            - **macOS**: `Strategy Monitor.dmg`
            
            ### Installation
            
            **Windows:**
            1. T√©l√©charger le `.exe`
            2. Double-cliquer pour lancer
            
            **macOS:**
            1. T√©l√©charger le `.dmg`
            2. Ouvrir et glisser l'app dans Applications
            3. Premi√®re ouverture: Clic droit ‚Üí Ouvrir (pour bypasser Gatekeeper)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}